<html>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
 <head>
  <title>Translation from Logical address to Physical Address</title>
  <script type="application/x-javascript">

var width = 30;
var scale = 2;
var address = 0;
var vmsize = 6;
var psize = 4096;
var pagetableString = "";
var pagetable = new Array(7);

var llow;
var lhigh;
var plow;
var phigh;

for(var i=0;i<vmsize;i++) {
    var v = Math.floor(Math.random()*vmsize);
    pagetable[i] = v;
    pagetableString += v.toString(16) +"\n";
}

function draw() {
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    canvas.ontouchmove = TouchXY;

    memory(ctx,10,10);
    memory(ctx,250,10);
    pointer(ctx,80,50);
    pointer(ctx,170,50);
    page(ctx, 130,120);

}

function text(name,text,x,y)
{
    // ctx.fillText(text,x*scale,y*scale);
    var X=document.body.scrollLeft+x*scale;
    var Y=document.body.scrollTop+y*scale;
    document.all[name].style.left=X+20;
    document.all[name].style.top=Y-5;
    document.all[name].innerText=text;
}


function MouseXY()
{
    var x = event.x/scale;
    var y = event.y/1;
    XY(x,y);
}

function TouchXY()
{
    var canvas = document.getElementById("canvas");
    var x =  event.pageX - canvas.offsetLeft;
    var y =  event.pageY - canvas.offsetTop
    XY(x,y);
}

function XY(x,y)
{
    if (10<=x&&x<=110&&10<=y&&y<=310) {
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");
	ctx.clearRect(10,10,10+60,410);
	memory(ctx,10,10);
	ctx.clearRect(250*scale,10,250*scale+60,410);
	memory(ctx,250,10);

	strokeRect(ctx,10,y,10+width,y+2);
        address = (y-10)*100;
        physical = translate(address);
	y = physical/100+10;
	strokeRect(ctx,250,y,250+width,y+2);
	update1();
    }
}

function update1() 
{
    text("Logical","logical address = 0x"+address.toString(16),10,150);
    text("Physical","physical address = 0x"+physical.toString(16),250,150);
    text("Pagetable",pagetableString,130,70);
    text("lhigh",lhigh.toString(16),90,32);
    text("llow",llow.toString(16),120,32);
    text("phigh",phigh.toString(16),90+90,32);
    text("plow",plow.toString(16),120+90,32);
}

function translate(adr)
{
    lhigh = Math.floor(adr/psize);
    llow = adr%psize;
    phigh = pagetable[lhigh];
    plow = llow;
    return phigh*psize+plow;
}

function strokeRect(ctx,x,y,x1,y1)
{
    return ctx.strokeRect(x*scale,y,(x1-x)*scale,(y1-y)*scale);
}

function pointer(ctx,x,y) {
    var dy = 10;
    strokeRect(ctx,x,y,x+width,y+dy);
    x += width;
    strokeRect(ctx,x,y,x+width,y+dy);
}

function memory(ctx,x,y) {
    var dy = 40;
    var dx = 40;

    for(var i=0;i<vmsize-1;i++) {
	strokeRect(ctx,x,y,x+width,y+dy);
	y += dy;
    }
}

function page(ctx,x,y) {
    var dy = 20;
    var dx = 40;

    for(var i=0;i<vmsize-1;i++) {
	strokeRect(ctx,x,y,x+width,y+dy);
	y += dy;
    }
    return box;
}

// メモリブロックのアニメーション用の変数
var animationRequestId = null;
var animationStartTime = null;
var animationDuration = 1000; // アニメーションの持続時間（ミリ秒）
var animationStartColor = "blue"; // アニメーション開始時の色
var animationEndColor = "red";   // アニメーション終了時の色

// メモリブロックの現在の色
var currentBlockColor = animationStartColor;

function animateMemoryBlock() {
    // アニメーション開始時刻を設定
    if (!animationStartTime) {
        animationStartTime = performance.now();
    }

    // 現在の経過時間を計算
    var currentTime = performance.now();
    var elapsedTime = currentTime - animationStartTime;

    // アニメーションの進捗を計算（0から1の範囲）
    var animationProgress = Math.min(elapsedTime / animationDuration, 1);

    // 現在のブロックの色を更新
    currentBlockColor = interpolateColors(animationStartColor, animationEndColor, animationProgress);

    // メモリブロックを再描画
    var canvas = document.getElementById("canvas");
    var ctx = canvas.getContext("2d");
    ctx.clearRect(10, 10, 10 + 60, 410);
    memory(ctx, 10, 10);

    // メモリブロックをアニメーション表示
    ctx.fillStyle = currentBlockColor;
    ctx.fillRect(10, addressToYCoordinate(address), width, 2);

    // アニメーションが終了したらアニメーションを停止
    if (animationProgress < 1) {
        animationRequestId = requestAnimationFrame(animateMemoryBlock);
    } else {
        animationStartTime = null;
        animationRequestId = null;
    }
}

function addressToYCoordinate(address) {
    // アドレスからY座標への変換ロジックを追加（必要に応じて実装）
    // この関数は、ロジカルアドレスをY座標に変換します。
}

function interpolateColors(startColor, endColor, progress) {
    // 色を補間するロジックを追加（必要に応じて実装）
    // startColorからendColorへの進捗（0から1の範囲）に応じて、中間の色を計算します。
}

function changeMemoryBlockColor() {
    // アニメーションが実行中であれば停止
    if (animationRequestId) {
        cancelAnimationFrame(animationRequestId);
        animationRequestId = null;
    }

    // メモリブロックのアニメーションを開始
    animateMemoryBlock();
}

// ユーザーがアクセス位置を変更したときに呼び出す関数（例：XY関数内で呼び出す）
function onAccessPositionChange() {
    // メモリブロックの色を変更してアニメーション
    changeMemoryBlockColor();
}



  </script>
 </head>
 <body onload="draw()" onclick="MouseXY();" touchstart="TouchXY();" >
   <canvas id="canvas" width="600" height="300"></canvas>
   <div id="Logical" style="position:absolute;font-size:12pt;"></div>
   <div id="Physical" style="position:absolute;font-size:12pt;"></div>
   <div id="Pagetable" style="position:absolute;font-size:12pt;"></div>
   <div id="llow" style="position:absolute;font-size:12pt;"></div>
   <div id="lhigh" style="position:absolute;font-size:12pt;"></div>
   <div id="plow" style="position:absolute;font-size:12pt;"></div>
   <div id="phigh" style="position:absolute;font-size:12pt;"></div>
  <H1>Translation from Logical address to Physical Address</H1></div>
 </body>
</html>
